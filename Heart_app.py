import streamlit as st
import pandas as pd
import numpy as np
import joblib
from sklearn.preprocessing import StandardScaler

# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –∏ —Ñ–∏—á–µ–π
@st.cache_resource
def load_model():
    model = joblib.load('best_model.pkl')
    return model

model = load_model()

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title('ü´Ä –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Å–µ—Ä–¥–µ—á–Ω—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π')
st.markdown("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è")

# –°–æ–∑–¥–∞–µ–º –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
col1, col2 = st.columns(2)

# –ü—Ä–∏–º–µ—Ä –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∏—á–∏)
with col1:
    age = st.number_input('–í–æ–∑—Ä–∞—Å—Ç', min_value=20, max_value=100, value=50)
    sex = st.selectbox('–ü–æ–ª', ['–ú—É–∂—Å–∫–æ–π', '–ñ–µ–Ω—Å–∫–∏–π'])
    cp = st.selectbox('–¢–∏–ø –±–æ–ª–∏ –≤ –≥—Ä—É–¥–∏', [
        '–¢–∏–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–æ–∫–∞—Ä–¥–∏—è', 
        '–ê—Ç–∏–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–æ–∫–∞—Ä–¥–∏—è',
        '–ë–æ–ª—å –±–µ–∑ —Å—Ç–µ–Ω–æ–∫–∞—Ä–¥–∏–∏',
        '–ë–µ–∑ —Å–∏–º–ø—Ç–æ–º–æ–≤'
    ])
    trestbps = st.number_input('–ê—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ (–º–º —Ä—Ç.—Å—Ç.)', 
                               min_value=80, max_value=200, value=120)

with col2:
    chol = st.number_input('–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω (–º–≥/–¥–ª)', min_value=100, max_value=600, value=200)
    fbs = st.selectbox('–£—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ –Ω–∞—Ç–æ—â–∞–∫ > 120 –º–≥/–¥–ª', ['–ù–µ—Ç', '–î–∞'])
    restecg = st.selectbox('–†–µ–∑—É–ª—å—Ç–∞—Ç –≠–ö–ì –≤ –ø–æ–∫–æ–µ', [
        '–ù–æ—Ä–º–∞',
        '–ù–∞–ª–∏—á–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ ST-T',
        '–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è –ª–µ–≤–æ–≥–æ –∂–µ–ª—É–¥–æ—á–∫–∞'
    ])
    thalach = st.number_input('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å', min_value=60, max_value=220, value=150)

# –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
if st.button('–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç', type='primary'):
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    sex_encoded = 1 if sex == '–ú—É–∂—Å–∫–æ–π' else 0
    fbs_encoded = 1 if fbs == '–î–∞' else 0
    
    # –ú–∞–ø–ø–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    cp_mapping = {
        '–¢–∏–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–æ–∫–∞—Ä–¥–∏—è': 1,
        '–ê—Ç–∏–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–æ–∫–∞—Ä–¥–∏—è': 2,
        '–ë–æ–ª—å –±–µ–∑ —Å—Ç–µ–Ω–æ–∫–∞—Ä–¥–∏–∏': 3,
        '–ë–µ–∑ —Å–∏–º–ø—Ç–æ–º–æ–≤': 0
    }
    cp_encoded = cp_mapping[cp]
    
    restecg_mapping = {'–ù–æ—Ä–º–∞': 0, '–ù–∞–ª–∏—á–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ ST-T': 1, '–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è –ª–µ–≤–æ–≥–æ –∂–µ–ª—É–¥–æ—á–∫–∞': 2}
    restecg_encoded = restecg_mapping[restecg]
    
    # –°–æ–∑–¥–∞–µ–º DataFrame —Å —Ñ–∏—á–∞–º–∏
    input_data = pd.DataFrame({
        'age': [age],
        'sex': [sex_encoded],
        'cp': [cp_encoded],
        'trestbps': [trestbps],
        'chol': [chol],
        'fbs': [fbs_encoded],
        'restecg': [restecg_encoded],
        'thalach': [thalach]
    })
    
    # –î–µ–ª–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    prediction = model.predict(input_data)[0]
    probability = model.predict_proba(input_data)[0][1]
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    st.markdown("---")
    if prediction == 1:
        st.error(f'üö® **–†–µ–∑—É–ª—å—Ç–∞—Ç: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Å–µ—Ä–¥–µ—á–Ω–æ–≥–æ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è**')
        st.metric(label="–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å", value=f"{probability*100:.1f}%", 
                  delta="–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫", delta_color="inverse")
    else:
        st.success(f'‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ —Å–µ—Ä–¥–µ—á–Ω–æ–≥–æ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è**')
        st.metric(label="–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å", value=f"{probability*100:.1f}%", 
                  delta="–Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫")
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    with st.expander("–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è"):
        st.write(f"**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–æ–≤:**")
        st.write(f"- –ë–æ–ª–µ–∑–Ω—å —Å–µ—Ä–¥—Ü–∞: {probability*100:.2f}%")
        st.write(f"- –ó–¥–æ—Ä–æ–≤: {(1-probability)*100:.2f}%")
        st.write(f"**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å:** CatBoost (Accuracy: 88.0%)")

# Sidebar —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
with st.sidebar:
    st.header("‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏")
    st.write("""
    –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è 
    –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ä–∏—Å–∫–∞ —Å–µ—Ä–¥–µ—á–Ω—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π.
    
    **–ú–æ–¥–µ–ª—å:** CatBoost
    **–¢–æ—á–Ω–æ—Å—Ç—å:** 88.0%
    **–î–∞–Ω–Ω—ã–µ:** Heart Disease Dataset
    """)
    
    st.header("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–¥–µ–ª–∏")
    st.metric("Accuracy", "88.04%")
    st.metric("Precision", "‚âà85%")
    st.metric("Recall", "‚âà90%")